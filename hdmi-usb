#!/bin/bash
# Start hdmi-usb.py as a background process and exit

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Build forwarded args, translating wrapper-only shorthands to hdmi-usb.py flags.
FORWARD_ARGS=()
SHOW_HELP=false
RESET_WINDOW=false

for arg in "$@"; do
    case "$arg" in
        -h|--help)
            SHOW_HELP=true
            FORWARD_ARGS+=("$arg")
            ;;
        --reset-window)
            RESET_WINDOW=true
            FORWARD_ARGS+=("$arg")
            ;;
        -d)
            # hdmi-usb.py accepts --debug (no -d). Translate for compatibility.
            FORWARD_ARGS+=("--debug")
            ;;
        *)
            FORWARD_ARGS+=("$arg")
            ;;
    esac
done

# For flags that are meant to print and exit, run in the foreground and skip
# device preflight/recovery.
if [ "$SHOW_HELP" = true ] || [ "$RESET_WINDOW" = true ]; then
    exec "${SCRIPT_DIR}/hdmi-usb.py" "${FORWARD_ARGS[@]}"
fi

# Check if USB Video HDMI capture device is connected
# Uses same detection logic as hdmi-usb.py (looks for "USB Video: USB Video")
if ! v4l2-ctl --list-devices 2>/dev/null | grep -q "USB Video: USB Video"; then
    echo "[ERR] No USB Video HDMI capture device detected"
    exit 1
fi

# Get the first video device from the USB Video block
VIDEO_DEV=$(v4l2-ctl --list-devices 2>/dev/null | awk '/USB Video: USB Video/{found=1; next} found && /\/dev\/video/{print $1; exit}')

# Check if device is in a bad state (STREAMON fails)
# Uses same logic as check_device_streaming() in hdmi-usb.py
if [ -n "$VIDEO_DEV" ]; then
    STREAM_ERR=$(v4l2-ctl -d "$VIDEO_DEV" --stream-mmap --stream-count=1 --stream-to=/dev/null 2>&1)
    if echo "$STREAM_ERR" | grep -qi "STREAMON.*error\|error.*STREAMON"; then
        echo "[INFO] Device $VIDEO_DEV streaming failed, attempting recovery..."
        
        # Try USB device reset first (faster than module reload)
        if command -v usbreset >/dev/null 2>&1; then
            echo "[INFO] Resetting USB device..."
            sudo usbreset 534d:2109 >/dev/null 2>&1
            sleep 1
        fi
        
        # Try to reset by reloading the uvcvideo module
        if sudo modprobe -r uvcvideo 2>/dev/null && sudo modprobe uvcvideo 2>/dev/null; then
            echo "[INFO] Module reloaded, waiting for device..."
            sleep 2
            
            # Re-detect the device after reload
            if ! v4l2-ctl --list-devices 2>/dev/null | grep -q "USB Video: USB Video"; then
                echo "[ERR] Device not found after recovery attempt"
                echo "[ERR] Try unplugging and replugging the USB device"
                exit 1
            fi
            
            # Update VIDEO_DEV after reload (device number may change)
            VIDEO_DEV=$(v4l2-ctl --list-devices 2>/dev/null | awk '/USB Video: USB Video/{found=1; next} found && /\/dev\/video/{print $1; exit}')
            
            # Check if streaming works now
            STREAM_ERR=$(v4l2-ctl -d "$VIDEO_DEV" --stream-mmap --stream-count=1 --stream-to=/dev/null 2>&1)
            if echo "$STREAM_ERR" | grep -qi "STREAMON.*error\|error.*STREAMON"; then
                echo "[ERR] Device $VIDEO_DEV still not streaming after recovery"
                echo "[ERR] Check that HDMI source is connected and sending a signal"
                echo "[ERR] Or try unplugging and replugging the USB device"
                exit 1
            fi
            echo "[INFO] Device recovered successfully"
        else
            echo "[ERR] Recovery failed (need sudo privileges)"
            echo "[ERR] Try: sudo modprobe -r uvcvideo && sudo modprobe uvcvideo"
            exit 1
        fi
    fi
fi

# Check if verbose logging is requested (app debug or GStreamer debug).
DEBUG_MODE=false
for arg in "${FORWARD_ARGS[@]}"; do
    if [[ "$arg" == "--debug" ]] || [[ "$arg" == "--gst-debug" ]]; then
        DEBUG_MODE=true
        break
    fi
done

# Run the Python script
if [ "$DEBUG_MODE" = true ]; then
    # Debug mode: show all output
    "${SCRIPT_DIR}/hdmi-usb.py" "${FORWARD_ARGS[@]}" &
else
    # Silent mode: redirect output to /dev/null
    "${SCRIPT_DIR}/hdmi-usb.py" "${FORWARD_ARGS[@]}" >/dev/null 2>&1 &
fi

